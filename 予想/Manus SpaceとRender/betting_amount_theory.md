# 購入金額の理論的設計

## 1. ケリー基準（Kelly Criterion）

### 理論
ケリー基準は、長期的な資産成長率を最大化するための最適な賭け金の割合を計算する数学的公式。

**ケリー公式:**
```
f* = (bp - q) / b
```

- f* = 最適な賭け金の割合
- b = オッズ（払戻倍率 - 1）
- p = 勝率
- q = 敗率（1 - p）

**例: オッズ2.0倍、勝率55%の場合**
- b = 2.0 - 1 = 1.0
- p = 0.55
- q = 0.45
- f* = (1.0 × 0.55 - 0.45) / 1.0 = 0.10 (10%)

### 競艇への適用
- 期待値 > 1 の場合のみ購入
- ケリー基準で計算した割合を基準に金額を決定
- リスク軽減のため、フルケリーではなく「ハーフケリー」（50%）を採用

---

## 2. 各戦略の特性と金額設定

### 2.1 関東4場単勝戦略（tansho_kanto）

**特性:**
- 期待回収率: 約129%
- 勝率: 約47%（1号艇）
- 平均オッズ: 約2.7倍

**金額設定ロジック:**
1. **基本金額**: 1,000円
2. **オッズ調整**: 
   - オッズ1.0〜1.5: 基本金額 × 1.0（低リターン）
   - オッズ1.5〜2.0: 基本金額 × 1.5
   - オッズ2.0〜3.0: 基本金額 × 2.0
   - オッズ3.0〜5.0: 基本金額 × 3.0（高リターン）
   - オッズ5.0以上: 基本金額 × 2.0（リスク軽減）

### 2.2 3穴戦略（bias_1_3）- 論文準拠

**特性:**
- 期待回収率: 約110-120%
- 勝率: 約10-15%（1-3の組み合わせ）
- 平均オッズ: 約8-12倍

**金額設定ロジック:**
1. **基本金額**: 1,000円
2. **当地勝率調整**:
   - 当地勝率6.5〜7.0: 基本金額 × 1.0
   - 当地勝率7.0〜7.5: 基本金額 × 1.5
   - 当地勝率7.5〜8.0: 基本金額 × 2.0
   - 当地勝率8.0以上: 基本金額 × 3.0
3. **オッズ調整**:
   - オッズ3.0〜5.0: × 1.5
   - オッズ5.0〜10.0: × 1.0
   - オッズ10.0〜20.0: × 0.8
   - オッズ20.0以上: × 0.5

### 2.3 3穴2nd戦略（bias_1_3_2nd）

**特性:**
- 期待回収率: 約110%
- 勝率: 約10-15%
- 当地勝率: 4.5〜6.0

**金額設定ロジック:**
1. **基本金額**: 1,000円
2. **当地勝率調整**:
   - 当地勝率4.5〜5.0: 基本金額 × 1.0
   - 当地勝率5.0〜5.5: 基本金額 × 1.5
   - 当地勝率5.5〜6.0: 基本金額 × 2.0
3. **オッズ調整**: bias_1_3と同様

---

## 3. 統合金額計算式

```python
def calculate_bet_amount(strategy_type, odds, local_win_rate=None):
    """
    購入金額を計算
    
    Args:
        strategy_type: 戦略タイプ
        odds: 最終オッズ
        local_win_rate: 当地勝率（3穴戦略のみ）
    
    Returns:
        購入金額（1,000〜10,000円）
    """
    BASE_AMOUNT = 1000
    MIN_AMOUNT = 1000
    MAX_AMOUNT = 10000
    
    if strategy_type == 'tansho_kanto':
        # 単勝戦略: オッズベースの調整
        if odds < 1.5:
            multiplier = 1.0
        elif odds < 2.0:
            multiplier = 1.5
        elif odds < 3.0:
            multiplier = 2.0
        elif odds < 5.0:
            multiplier = 3.0
        else:
            multiplier = 2.0  # 高オッズはリスク軽減
    
    elif strategy_type in ['bias_1_3', 'bias_1_3_2nd']:
        # 3穴戦略: 当地勝率 × オッズの調整
        
        # 当地勝率による調整
        if local_win_rate is None:
            rate_multiplier = 1.0
        elif strategy_type == 'bias_1_3':
            if local_win_rate < 7.0:
                rate_multiplier = 1.0
            elif local_win_rate < 7.5:
                rate_multiplier = 1.5
            elif local_win_rate < 8.0:
                rate_multiplier = 2.0
            else:
                rate_multiplier = 3.0
        else:  # bias_1_3_2nd
            if local_win_rate < 5.0:
                rate_multiplier = 1.0
            elif local_win_rate < 5.5:
                rate_multiplier = 1.5
            else:
                rate_multiplier = 2.0
        
        # オッズによる調整
        if odds < 5.0:
            odds_multiplier = 1.5
        elif odds < 10.0:
            odds_multiplier = 1.0
        elif odds < 20.0:
            odds_multiplier = 0.8
        else:
            odds_multiplier = 0.5
        
        multiplier = rate_multiplier * odds_multiplier
    
    else:
        multiplier = 1.0
    
    # 最終金額を計算（100円単位に丸め）
    amount = int(BASE_AMOUNT * multiplier / 100) * 100
    
    # 上下限を適用
    return max(MIN_AMOUNT, min(MAX_AMOUNT, amount))
```

---

## 4. 期待値に基づく検証

### ケリー基準による検証

**関東4場単勝戦略の場合:**
- 勝率 p = 0.47
- 平均オッズ = 2.7
- b = 2.7 - 1 = 1.7
- f* = (1.7 × 0.47 - 0.53) / 1.7 = 0.158 (15.8%)

資金10万円の場合、最適賭け金 = 15,800円
→ ハーフケリーで約8,000円が理論的最適値

**3穴戦略の場合:**
- 勝率 p = 0.12
- 平均オッズ = 10.0
- b = 10.0 - 1 = 9.0
- f* = (9.0 × 0.12 - 0.88) / 9.0 = 0.022 (2.2%)

資金10万円の場合、最適賭け金 = 2,200円
→ ハーフケリーで約1,100円が理論的最適値

---

## 5. 結論

| 戦略 | 基本金額 | 調整要素 | 金額範囲 |
|------|----------|----------|----------|
| tansho_kanto | 1,000円 | オッズ | 1,000〜3,000円 |
| bias_1_3 | 1,000円 | 当地勝率×オッズ | 1,000〜4,500円 |
| bias_1_3_2nd | 1,000円 | 当地勝率×オッズ | 1,000〜3,000円 |

**理論的根拠:**
1. ケリー基準に基づく最適賭け金の計算
2. 期待値が高い条件（高当地勝率、適正オッズ）で金額を増加
3. リスク軽減のためハーフケリーを採用
4. 上限10,000円、下限1,000円の制約を適用
