# バージョン履歴

## Ver1.63 (2026-01-26)
### 変更内容
- **仮想払戻金を1000円ベースで計算**: 見送り分析の仮想払戻金を100円単位から1000円投資ベースに換算
  - 例: 払戻金120円 → 1000円投資なら払戻1200円

---

## Ver1.62 (2026-01-26)
### 変更内容
- **見送りレース詳細APIの修正**: bet_type日本語→英語変換とauto対応を追加
  - 見送りレースの仮想払戻/判定/仮想損益が正しく表示される
  - 1000円投資として仮想損益を計算

---

## Ver1.61 (2026-01-26)
### 変更内容
- **結果反映処理の修正**: confirmedレコードをwon/lostに更新する処理を直接実装
  - payoff/return_amount/profitをDBに保存
  - 累計統計（購入数、的中率、回収率、累計損益）が正しく表示

---

## Ver1.60 (2026-01-26)
### 変更内容
- **見送り分析のauto bet_type対応**: bet_type='auto'（bias_1_3_2nd戦略）でも仮想払戻金を計算
  - 見送り分析サブタブで仮想払戻金・仮想回収率が正しく表示

---

## Ver1.59 (2026-01-26)
### 変更内容
- **払戻金検索のbet_type日本語対応**: payoffsテーブルの日本語bet_type（2連複、2連単）を英語（quinella、exacta）に変換して検索
  - 見送り分析の「仮想払戻金」が正しく表示される
  - 購入履歴の「払戻金」「損益」が正しく表示される

---

## Ver1.58 (2026-01-26)
### 変更内容
- **購入履歴の払戻金・損益をAPI側で計算**: confirmed/won/lostレースでもpayoffsテーブルから払戻金を取得し、return_amount/profitを計算
  - DBのpayoff/return_amount/profitがNULLでも正しく表示

---

## Ver1.57 (2026-01-26)
### 変更内容
- **朝バッチで当日番組表取得**: 毎朝6:00のdaily_batchで公式サイトから当日の番組表を取得
  - 1号艇の当地勝率がDBに保存される
  - 「当地勝率取得失敗」問題が解消

---

## Ver1.56 (2026-01-26)
### 変更内容
- **LZHワイド継続行パース修正**: import_historical_data.pyでワイドの2-3行目が検出できないバグを修正
  - `^\s+\d-\d` → `^\d-\d` に変更（strippedは既にstrip()済みなので先頭スペースがない）
  - これによりhistorical_payoffsにワイド3組が正しく保存される

---

## Ver1.55 (2026-01-26)
### 変更内容
- **複勝・ワイド複数組パース修正**: collector.pyの払戻金テーブル解析をrowspan対応
  - 公式サイトのHTMLは複勝・ワイドを複数行に分割（rowspan）
  - 2行目以降は勝式セルがないため、前回の勝式を記憶して継続行として処理
  - これにより複勝2組・ワイド3組がDBに保存される

---

## Ver1.54 (2026-01-26)
### 変更内容
- **複勝・ワイド複数組対応（追加修正）**: モーダル詳細APIのbet_type変換マップに日本語名を追加
  - DBには日本語名（'複勝', 'ワイド'）で保存されていたため変換できなかった

---

## Ver1.53 (2026-01-26)
### 変更内容
- **複勝・ワイド複数組対応**: ダッシュボードAPIで複勝（2組）とワイド（3組）を返すように修正
  - `api.py`: payoffsレスポンスにplace/wideを追加

---

## Ver1.52 (2026-01-26)
### 変更内容
- **オッズ収集高速化 (v9.2)**: スケジュール取得を公式サイト24場スクレイピング→DBからSQL取得に変更
  - 処理時間: 3-4分 → 数秒
  - リアルタイム性: オッズ取得は公式サイトから維持
  - 対象レース: 締切10分→5分以内に絞る
- **購入判断ウィンドウ**: 5分→2分に変更（処理高速化により可能に）

---

## Ver1.51 (2026-01-26)
### 変更内容
- **締切チェックウィンドウ拡大**: 3分→5分に変更
  - ジョブ処理時間が3-4分かかるため、3分前では間に合わなかった
  - `virtual_betting.py`: `process_deadline_bets`, `_process_bias_1_3_strategy`, `_process_win_10x_strategy`
  - `cron_jobs.py`: `has_betting_target`チェック

---

## Ver1.50 (2026-01-26)
### 変更内容
- **時間関連コード全体修正**: SQLの`NOW()`を全てJSTパラメータに置換
  - `collector.py`: `run_result_collection`の締切比較
  - `virtual_betting.py`: 両戦略の締切チェック（Ver1.49で修正済み）
- grepで`NOW()`使用箇所を全検索し、時刻比較に使用している箇所を全て修正

---

## Ver1.49 (2026-01-26)
### 変更内容
- **締切超過問題の根本修正**: SQLの`NOW()`をJSTパラメータに置換（Render PostgreSQLはUTCのため9時間ずれていた）
- 対象: `_process_bias_1_3_strategy`, `_process_win_10x_strategy`

---

## Ver1.48 (2026-01-26)
### 変更内容
- **見送りレースの払戻金表示修正**: 締切超過（pending→表示上skipped）のレースでも払戻金を計算
- **auto bet_type対応**: 2連複で的中判定し払戻金を取得

---

## Ver1.47 (2026-01-26)
### 変更内容
- **今日のレース ソート機能追加**: 開催地順/時間（早い順）/時間（遅い順）で切り替え可能
- **今日のレース 詳細ボタン追加**: 結果確定レースで詳細モーダル表示

---

## Ver1.46 (2026-01-26)
### 変更内容
- **締切超過バグ修正**: `virtual_betting.py`の`get_connection()`→`get_db_connection()`タイプミス修正
- **影響**: `_process_bias_1_3_strategy`と`_process_win_10x_strategy`が正常動作するように

---

## Ver1.45 (2026-01-26)
### 変更内容
- **複勝・ワイド複数レコード収集対応**: collector.pyで複勝（2-3件）・ワイド（最大3件）を全件収集・保存するよう修正
- **リアルタイム払戻金改善**: これまで1件のみ保存されていた問題を解消

---

## Ver1.44 (2026-01-26)
### 変更内容
- **複勝・ワイド払戻表示追加**: 今日のレース一覧に複勝払戻・ワイド払戻列を追加
- **複数レコード表示対応**: 複勝（2-3件）・ワイド（最大3件）を全て表示
- **bet_type正規化**: 日本語/英語の混在を統一（単勝→win, 複勝→place, ワイド→wide等）

---

## Ver1.42 (2026-01-26)
### 変更内容
- **累計統計の計算修正**: 全回収/全投資額の計算で`pending`/`confirmed`/`skipped`を除外し、`won`/`lost`のみを対象に
- **購入予定登録ロジック修正**:
  - `bias_1_3_2nd`: 朝に15パターンを`pending`登録、締切3分前にオッズ判断
  - `win_10x_1_3`: 朝登録なし、締切3分前に直接チェックして1号艇単勝10倍以上なら購入
- **レース収集修正**: `collector.py`のステータスチェックを緩和（「発売開始前」も収集対象に）
- **会場コード修正**: 蒲郡(07)、江戸川(03)、平和島(04)、徳山(18)を正しい値に修正

---

## Ver1.41 (2026-01-25)
### 変更内容
- **2戦略表示対応**: 3穴2nd戦略・１単勝10倍以上１－３戦略の両方を表示
- **資金状況タブ追加**: 戦略別の稼働状況を表示

---

## Ver1.40 (2026-01-24)
### 変更内容
- **仮想購入システム実装**: virtual_betsテーブルによる購入シミュレーション
- **ダッシュボード刷新**: 本日統計・累計統計の表示追加
