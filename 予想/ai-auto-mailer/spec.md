# AIメールシステム 仕様書

## 1. 概要

本システムは、指定されたIMAPメールアカウントを定期的にチェックし、受信したメールをAI（Google Gemini）を用いて要約・分析するWebアプリケーションである。分析結果（重要度、要約、返信要否、返信案）はChatworkに通知される。ユーザーはWeb UIを通じてメールアカウントの管理や分析結果の閲覧が可能。

元々はメールでの通知機能も存在したが、さくらインターネットのSMTPサーバーとの接続問題により、現在はChatwork通知に一本化されている。

## 2. 機能一覧

| 大項目 | 機能 | 説明 |
| :--- | :--- | :--- |
| **メールアカウント管理** | アカウント追加 | IMAPサーバー情報とChatworkルームIDを登録する。 |
| | アカウント一覧 | 登録済みのアカウント情報を表示・管理する。 |
| | アカウント削除 | 登録済みのアカウントを削除する。 |
| | IMAP接続テスト | 登録前に入力されたIMAP情報で接続をテストする。 |
| **メール自動処理** | メール受信 | 5分ごとに全アクティブアカウントの新着メールをIMAPで受信する。 |
| | メール分析 | 受信したメールをGemini APIに送信し、要約、重要度判定、返信要否判定、返信案生成を行う。 |
| | Chatwork通知 | 分析結果を整形し、指定されたChatworkルームに通知する。 |
| **データ管理** | 要約データリセット | 特定アカウントまたは全アカウントの要約データを削除し、再分析を促す。 |
| **ユーザー設定** | AI分析カスタマイズ | ユーザー名、会社名、重要キーワードなどを設定し、AIの分析精度を向上させる。 |

## 3. システム構成

本システムは、フロントエンド、バックエンド、データベース、外部サービスで構成される。

- **フロントエンド**: React, TypeScript, Vite, TailwindCSS
- **バックエンド**: Node.js, Express, tRPC, Drizzle ORM
- **データベース**: PostgreSQL
- **外部サービス**:
  - **Google Gemini API**: メールの要約・分析
  - **Chatwork API**: 分析結果の通知

```
+-----------------+      +---------------------+      +-----------------------+
|   ユーザー      | ---> |   フロントエンド    | <--> |      バックエンド     | 
| (ブラウザ)      |      | (React, Vite)       |      | (Node.js, Express)    |
+-----------------+      +---------------------+      +-----------+-----------+
                                                           |           ^
                                                           |           |
                                                           v           |
                                                     +-----------+-----------+
                                                     |   データベース (PostgreSQL) |
                                                     +-----------------------+
                                                           |           ^
                                                           |           |
                                                           v           |
+-----------------------+      +-----------------------+      +-----------------------+
| Google Gemini API     | <--- |      メール分析       | <--- |      メール受信       |
| (要約・返信案生成)    |      | (llm.ts)              |      | (emailService.ts)     |
+-----------------------+      +-----------------------+      +-----------+-----------+
                                                                       |
                                                                       v
                                                                 +-----------+
                                                                 | IMAPサーバー |
                                                                 +-----------+

+-----------------------+
|   Chatwork API        | <--- バックエンド (通知処理)
| (通知送信)            |
+-----------------------+
```

## 4. データベース設計

`drizzle/schema.ts` にて定義。主要なテーブルは以下の通り。

| テーブル名 | 説明 |
| :--- | :--- |
| `users` | ユーザー情報（現在はローカル認証が主） |
| `userSettings` | AI分析のカスタマイズ設定（ユーザー名、会社名、キーワード等） |
| `emailAccounts` | 監視対象のIMAPアカウント情報（ホスト、ユーザー、パスワード、ChatworkルームID等） |
| `emailSummaries` | AIによるメール分析結果（要約、重要度、返信案等）を格納する。 |
| `ignoredSenders` | 無視する送信者リスト |

### `emailSummaries` テーブル詳細

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | integer | 主キー |
| `accountId` | integer | `emailAccounts`テーブルへの外部キー |
| `messageId` | varchar | メールのユニークID |
| `sender` | varchar | 送信者メールアドレス |
| `senderName` | varchar | AIが抽出した送信者名 |
| `subject` | text | 件名 |
| `summary` | text | AIが生成した要約 |
| `importance` | enum | 重要度 (high, medium, low, spam) |
| `needsReply` | enum | 返信要否 (yes, no, unknown) |
| `replyReason` | text | 返信が必要な理由 |
| `replySuggestion` | text | AIが生成した返信案 |
| `isNotified` | enum | 通知済みフラグ (yes, no) |
| `receivedAt` | timestamp | メール受信日時 |

## 5. 主要な処理フロー

### 5.1. メール受信と分析 (バッチ処理)

1.  **スケジューラ起動 (`batchScheduler.ts`)**: 5分ごとに`processAllAccounts`関数を実行する。
2.  **アカウント取得**: `db.getActiveEmailAccounts`で有効な全メールアカウントを取得する。
3.  **メール受信 (`emailService.ts#fetchNewEmails`)**: 各アカウントについて、Pythonスクリプト(`imap_client.py`)を実行し、IMAPサーバーから新着メールを取得する。
4.  **メール分析 (`emailService.ts#analyzeEmail`)**: 取得した各メールについて、`llm.ts`の`analyzeEmailWithGemini`関数を呼び出す。
5.  **AIプロンプト実行 (`llm.ts`)**: ユーザー設定を反映した詳細なプロンプトを生成し、Gemini APIに送信する。
6.  **結果保存**: Geminiから返されたJSON（要約、重要度、返信案等）を`emailSummaries`テーブルに保存する。

### 5.2. Chatwork通知

1.  **通知対象の取得 (`batchScheduler.ts`)**: `db.getUnnotifiedSummaries`で未通知の分析結果を取得する。
2.  **メッセージ生成 (`chatworkService.ts`)**: 取得した分析結果を元に、Chatwork用の整形済みメッセージを生成する。
    - 返信が必要なメール、確認のみのメールを分類して表示。
    - 営業メールなどは件数のみ表示。
3.  **API送信**: Chatwork APIを叩き、指定されたルームIDにメッセージを送信する。
4.  **通知済みフラグ更新**: 通知が成功したら、対象の`emailSummaries`レコードの`isNotified`を`yes`に更新する。

## 6. AI要約・返信案生成プロンプト

`server/llm.ts`に定義されているプロンプトがシステムの核となる。主な指示は以下の通り。

- **役割設定**: 「優秀なビジネス秘書AI」として振る舞う。
- **要約ルール**: 
  - 「確認」「依頼」のような短い要約は禁止。
  - 日付、依頼内容、固有名詞など具体的な情報をすべて含める。
  - 文字数は80〜150文字程度。
- **返信案生成ルール**:
  - ユーザー設定の名前（例: 番野）で始める。
  - メールの具体的な内容（日付など）を返信案に含める。
  - 複数の依頼があればすべてに言及する。

## 7. フロントエンド

Reactとshadcn/uiを用いたモダンなUIで構成される。

- **`Settings.tsx`**: メールアカウントの追加・一覧・削除、ChatworkルームIDの設定を行う中心的なページ。
- **`UserSettings.tsx`**: AIの分析精度を向上させるための個人設定（名前、会社名、キーワード）を行うページ。
- **`Summaries.tsx`**: 過去に分析されたメールの要約を一覧で確認できるページ。

## 8. 今後の課題

- **エラーハンドリング強化**: IMAP接続やAPIエラー時のリトライ処理、ユーザーへの詳細なフィードバック。
- **UI/UX改善**: 設定項目の説明をより分かりやすくし、初心者でも使いやすいインターフェースを目指す。
- **テスト拡充**: 各機能の単体テスト・結合テストを拡充し、デプロイ前の品質を担保する。
