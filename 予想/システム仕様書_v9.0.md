# 競艇予想AIシステム v9.0 サービス仕様書

最終更新: 2026-01-25

---

## 概要

| 項目 | 内容 |
|------|------|
| **リポジトリ** | `makoban/ai-auto-mailer` |
| **データベース** | PostgreSQL (`kokotomo-db-staging`) |
| **ホスティング** | Render.com (Singapore) |
| **月額コスト** | 約$10〜12（DB $7 + Cron $3〜5） |

---

## サービス一覧

### 新構成（v9.0 推奨）

| サービス名 | タイプ | スケジュール | コスト |
|-----------|--------|------------|--------|
| `boatrace-daily-batch` | Cron Job | 毎朝6時 JST | $1/月 |
| `boatrace-betting-process` | Cron Job | 毎分 (8:00-23:00 JST) | $1/月 |
| `boatrace-result-collection` | Cron Job | 5分ごと (8:00-24:00 JST) | $1/月 |
| `boatrace-dashboard` | Web Service | 常時 | 無料 |
| `kokotomo-db-staging` | PostgreSQL | 常時 | $7/月 |

### レガシー（廃止予定）

| サービス名 | 理由 |
|-----------|------|
| `boatrace-odds-high-freq-worker` | $7/月のBackground Worker → betting-processに統合 |
| `boatrace-daily-register` | daily-batchに統合 |
| `boatrace-daily-collection` | daily-batchに統合 |
| `boatrace-historical-import` | daily-batchに統合 |
| `boatrace-lzh-daily-import` | daily-batchに統合 |
| `boatrace-odds-regular` | betting-processに統合 |
| `boatrace-decide-bets` | betting-processに統合 |
| `boatrace-result-update` | result-collectionに統合 |

---

## サービス詳細

---

### 1. boatrace-daily-batch

**統合日次バッチ**

| 項目 | 値 |
|------|-----|
| **タイプ** | Cron Job |
| **スケジュール** | `0 21 * * *` (毎日 6:00 JST) |
| **ディレクトリ** | `boatrace-collector/src` |
| **コマンド** | `python cron_jobs.py daily_batch` |
| **実行関数** | `job_daily_batch()` |

#### 処理内容

```
Step 1: 前日結果LZHインポート
  ↓ import_historical_data.py yesterday
Step 2: 過去データ一括インポート
  ↓ import_historical_data.py all
Step 3: 当日レース情報収集
  ↓ collector.run_daily_collection()
Step 4: 購入予定登録
  ↓ VirtualBettingManager.register_daily_bets()
```

#### 環境変数

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `DATABASE_URL` | PostgreSQL接続文字列 | ✅ |
| `TZ` | タイムゾーン (`Asia/Tokyo`) | ✅ |
| `MAX_MONTHS_PER_RUN` | 過去データ取得月数 (`40`) | オプション |

#### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `cron_jobs.py` | エントリポイント、`job_daily_batch()` |
| `import_historical_data.py` | LZH/過去データインポート |
| `collector.py` | レース情報収集 |
| `virtual_betting.py` | 購入予定登録 |

---

### 2. boatrace-betting-process

**オッズ収集+購入判断バッチ**

| 項目 | 値 |
|------|-----|
| **タイプ** | Cron Job |
| **スケジュール** | `* 23,0-14 * * *` (毎分 8:00-23:00 JST) |
| **ディレクトリ** | `boatrace-collector/src` |
| **コマンド** | `python cron_jobs.py betting` |
| **実行関数** | `job_betting_process()` |

#### 処理フロー

```
運用時間チェック (8:00-23:00 JST)
    ↓
早期終了チェック
  - 締切10分以内のレースなし AND
  - 締切2分以内のレースなし
  → 即終了（従量課金を最小化）
    ↓
[締切10分以内あり] オッズ収集
  - 単勝・複勝・2連単・2連複を取得
  - odds_historyテーブルに保存
    ↓
[締切2分以内あり] 購入判断
  - pendingレースの最終オッズを確認
  - 条件を満たせばconfirmed、満たさなければskipped
  - 締切超過レースをskippedに更新
```

#### 環境変数

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `DATABASE_URL` | PostgreSQL接続文字列 | ✅ |
| `TZ` | タイムゾーン (`Asia/Tokyo`) | ✅ |

#### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `cron_jobs.py` | エントリポイント、`job_betting_process()` |
| `collect_odds.py` | オッズ取得・保存 |
| `virtual_betting.py` | 購入判断処理 |

---

### 3. boatrace-result-collection

**結果収集バッチ**

| 項目 | 値 |
|------|-----|
| **タイプ** | Cron Job |
| **スケジュール** | `*/5 23,0-15 * * *` (5分ごと 8:00-24:00 JST) |
| **ディレクトリ** | `boatrace-collector/src` |
| **コマンド** | `python cron_jobs.py result` |
| **実行関数** | `job_result_collection()` |

#### 処理フロー

```
早期終了チェック
  - 締切後15分以内のレースなし
  → 即終了（従量課金を最小化）
    ↓
レース結果収集
  - 公式サイトから着順・払戻金を取得
  - race_results, payoffsテーブルに保存
  - historical_race_results, historical_payoffsにも保存
    ↓
仮想購入結果更新
  - confirmedレースの的中/不的中を判定
  - virtual_betsのstatus, profit等を更新
```

#### 環境変数

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `DATABASE_URL` | PostgreSQL接続文字列 | ✅ |
| `TZ` | タイムゾーン (`Asia/Tokyo`) | ✅ |

#### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `cron_jobs.py` | エントリポイント、`job_result_collection()` |
| `collector.py` | 結果収集 (`run_result_collection()`) |
| `virtual_betting.py` | 仮想購入結果更新 |

---

### 4. boatrace-dashboard

**ダッシュボードAPI**

| 項目 | 値 |
|------|-----|
| **タイプ** | Web Service |
| **プラン** | Free |
| **ディレクトリ** | `boatrace-dashboard` |
| **コマンド** | `uvicorn api:app --host 0.0.0.0 --port $PORT` |

#### 機能

- 仮想購入一覧の表示
- 戦略別パフォーマンスの表示
- レース情報・オッズの表示

#### 環境変数

| 変数名 | 説明 | 必須 |
|--------|------|------|
| `DATABASE_URL` | PostgreSQL接続文字列 | ✅ |
| `TZ` | タイムゾーン (`Asia/Tokyo`) | ✅ |

#### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `api.py` | FastAPI アプリケーション |
| `auto_betting.py` | 購入処理（レガシー、参照用） |

---

### 5. kokotomo-db-staging

**PostgreSQLデータベース**

| 項目 | 値 |
|------|-----|
| **タイプ** | PostgreSQL |
| **プラン** | Basic 256MB ($7/月) |
| **リージョン** | Singapore |
| **ホスト** | `dpg-xxx.singapore-postgres.render.com` |

#### 主要テーブル

| テーブル名 | 用途 |
|-----------|------|
| `races` | 当日のレース情報 |
| `odds` | 最新オッズ |
| `odds_history` | オッズ履歴（時系列） |
| `race_results` | レース結果 |
| `payoffs` | 払戻金 |
| `virtual_bets` | 仮想購入記録 |
| `virtual_funds` | 戦略別資金管理 |
| `historical_race_results` | 過去レース結果（20年分） |
| `historical_programs` | 過去出走表（20年分） |
| `historical_payoffs` | 過去払戻金（20年分） |
| `stadiums` | 競艇場マスタ |

---

## ディレクトリ構成

```
ai-auto-mailer/
├── render.yaml                    # Renderサービス定義
├── shared/
│   └── version.ts                 # バージョン管理
├── boatrace-collector/
│   ├── requirements.txt           # Python依存関係
│   └── src/
│       ├── cron_jobs.py           # 全Cron Jobのエントリポイント
│       ├── collector.py           # レース情報・結果収集
│       ├── collect_odds.py        # オッズ収集
│       ├── virtual_betting.py     # 仮想購入処理
│       ├── import_historical_data.py  # 過去データインポート
│       ├── odds_worker.py         # 高頻度Worker（レガシー）
│       └── update_skip_reasons.py # skipReason更新
└── boatrace-dashboard/
    ├── requirements.txt           # Python依存関係
    ├── api.py                     # ダッシュボードAPI
    ├── auto_betting.py            # 購入処理（レガシー）
    └── render.yaml                # サービス定義（レガシー）
```

---

## 戦略設定

### 1. tansho_kanto（関東4場単勝戦略）

| 項目 | 値 |
|------|-----|
| **対象場** | 桐生(01), 戸田(02), 平和島(04), 多摩川(05) |
| **対象R** | 場によって異なる |
| **購入種別** | 単勝 1号艇 |
| **オッズ条件** | 1.0〜999.0 |
| **購入金額** | 1,000円 |
| **追加条件** | 1号艇当地勝率 >= 6.5% |

### 2. bias_1_3_2nd（3穴2nd戦略）

| 項目 | 値 |
|------|-----|
| **対象条件** | 特定の場+Rの組み合わせ（15パターン） |
| **購入種別** | 2連単または2連複 1-3 |
| **オッズ条件** | 3.0〜100.0 |
| **購入金額** | 1,000円 |
| **追加条件** | 1号艇当地勝率 4.5〜6.0% |

---

## 運用スケジュール（JST）

| 時刻 | 処理 |
|------|------|
| 06:00 | `daily-batch`: LZH+過去データ+レース情報+購入予定登録 |
| 08:00-23:00 | `betting-process`: 毎分オッズ収集+購入判断 |
| 08:00-24:00 | `result-collection`: 5分ごと結果収集 |

---

## コスト詳細

| サービス | タイプ | 料金 |
|----------|--------|------|
| `kokotomo-db-staging` | PostgreSQL | $7/月 |
| `boatrace-daily-batch` | Cron Job | $1/月（最低） |
| `boatrace-betting-process` | Cron Job | $1/月（最低） |
| `boatrace-result-collection` | Cron Job | $1/月（最低） |
| `boatrace-dashboard` | Web Service | 無料 |
| **合計** | | **$10/月** |

※ Cron Jobは実行時間に応じた従量課金（最低$1/月）

---

## 廃止後の削除手順

動作確認後、Renderダッシュボードから以下を削除:

1. `boatrace-odds-high-freq-worker` （最優先、$7/月削減）
2. `boatrace-daily-register`
3. `boatrace-daily-collection`
4. `boatrace-historical-import`
5. `boatrace-lzh-daily-import`
6. `boatrace-odds-regular`
7. `boatrace-decide-bets`
8. `boatrace-result-update`
9. `boatrace-lzh-backfill-temp`
